name: Deploy AWS Infrastructure

on:
  workflow_dispatch:
    inputs:
      customer:
        description: 'Customer name'
        required: true
        type: string
      environment:
        description: 'Environment (dev/staging/prod)'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      vpc_cidr:
        description: 'VPC CIDR (optional - overrides BOM)'
        required: false
        type: string
      force_network_deploy:
        description: 'Force network deployment (dangerous)'
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: eu-north-1
  CUSTOMER: ${{ github.event.inputs.customer }}
  ENVIRONMENT: ${{ github.event.inputs.environment }}

jobs:
  validate-bom:
    runs-on: ubuntu-latest
    outputs:
      network-needed: ${{ steps.check.outputs.network-needed }}
      services-to-deploy: ${{ steps.check.outputs.services-to-deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install boto3 pyyaml pandas

      - name: Validate BOM
        run: |
          python scripts/validate-bom.py

      - name: Check deployment requirements
        id: check
        run: |
          python scripts/parse-bom.py --customer "${{ env.CUSTOMER }}" --environment "${{ env.ENVIRONMENT }}" --check-only

  deploy-network:
    runs-on: ubuntu-latest
    needs: validate-bom
    if: needs.validate-bom.outputs.network-needed == 'true'
    environment: 
      name: production-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_DEPLOYMENT_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install boto3 pyyaml pandas

      - name: Check if network stack exists
        id: check-network
        run: |
          STACK_NAME="${{ env.CUSTOMER }}-${{ env.ENVIRONMENT }}-network-foundation"
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            if [ "${{ github.event.inputs.force_network_deploy }}" != "true" ]; then
              echo "ERROR: Network stack $STACK_NAME already exists!"
              echo "Network stacks are immutable and cannot be updated."
              echo "If you need to redeploy, set force_network_deploy to true (DANGEROUS)."
              exit 1
            else
              echo "WARNING: Forcing network deployment on existing stack!"
            fi
          fi
          echo "stack-name=$STACK_NAME" >> $GITHUB_OUTPUT

      - name: Generate network parameters
        run: |
          python scripts/parse-bom.py --customer "${{ env.CUSTOMER }}" --environment "${{ env.ENVIRONMENT }}" --generate-network-params --vpc-cidr "${{ github.event.inputs.vpc_cidr }}"

      - name: Deploy network foundation
        run: |
          STACK_NAME="${{ steps.check-network.outputs.stack-name }}"
          aws cloudformation deploy \
            --template-file network/network-foundation.yml \
            --stack-name "$STACK_NAME" \
            --parameter-overrides file://network-params.json \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Verify network deployment
        run: |
          STACK_NAME="${{ steps.check-network.outputs.stack-name }}"
          aws cloudformation wait stack-deploy-complete --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }}
          echo "Network foundation deployed successfully: $STACK_NAME"

  deploy-services:
    runs-on: ubuntu-latest
    needs: [validate-bom, deploy-network]
    if: always() && needs.validate-bom.outputs.services-to-deploy != '[]'
    environment: 
      name: production-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        service: ${{ fromJson(needs.validate-bom.outputs.services-to-deploy) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_DEPLOYMENT_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install boto3 pyyaml pandas

      - name: Check if service stack exists
        id: check-service
        run: |
          STACK_NAME="${{ env.CUSTOMER }}-${{ env.ENVIRONMENT }}-${{ matrix.service.name }}-${{ matrix.service.instance_id }}"
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "ERROR: Service stack $STACK_NAME already exists!"
            echo "Service stacks are append-only. Use a different instance ID for new deployments."
            exit 1
          fi
          echo "stack-name=$STACK_NAME" >> $GITHUB_OUTPUT

      - name: Generate service parameters
        run: |
          python scripts/parse-bom.py --customer "${{ env.CUSTOMER }}" --environment "${{ env.ENVIRONMENT }}" --generate-service-params --service-name "${{ matrix.service.name }}" --instance-id "${{ matrix.service.instance_id }}"

      - name: Deploy service
        run: |
          STACK_NAME="${{ steps.check-service.outputs.stack-name }}"
          TEMPLATE_FILE="services/${{ matrix.service.template }}"
          
          aws cloudformation deploy \
            --template-file "$TEMPLATE_FILE" \
            --stack-name "$STACK_NAME" \
            --parameter-overrides file://service-params-${{ matrix.service.name }}-${{ matrix.service.instance_id }}.json \
            --capabilities CAPABILITY_IAM \
            --region ${{ env.AWS_REGION }} \
            --no-fail-on-empty-changeset

      - name: Verify service deployment
        run: |
          STACK_NAME="${{ steps.check-service.outputs.stack-name }}"
          aws cloudformation wait stack-deploy-complete --stack-name "$STACK_NAME" --region ${{ env.AWS_REGION }}
          echo "Service deployed successfully: $STACK_NAME"

  deployment-summary:
    runs-on: ubuntu-latest
    needs: [validate-bom, deploy-network, deploy-services]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Customer: ${{ env.CUSTOMER }}" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- Region: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Network deployment needed: ${{ needs.validate-bom.outputs.network-needed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Services to deploy: ${{ needs.validate-bom.outputs.services-to-deploy }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-network.result }}" = "success" ]; then
            echo "✅ Network foundation deployed successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-network.result }}" = "skipped" ]; then
            echo "⏭️ Network deployment skipped (already exists)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-network.result }}" = "failure" ]; then
            echo "❌ Network deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.deploy-services.result }}" = "success" ]; then
            echo "✅ All services deployed successfully" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-services.result }}" = "skipped" ]; then
            echo "⏭️ Service deployment skipped (no services to deploy)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-services.result }}" = "failure" ]; then
            echo "❌ Some service deployments failed" >> $GITHUB_STEP_SUMMARY
          fi